- name: apply roles
  hosts: dokku_servers
  roles:
  # add whatever roles you need
  - role: dokku_bot.ansible_dokku
    tags: dokku
    become: true
  tasks:
  - name: Create seekpath app
    dokku_clone:
      app: seekpath
      repository: https://github.com/materialscloud-org/tools-seekpath
      version: v21.06.0
    tags: my_dokku_apps
  - name: Configure ports for seekpath app
    dokku_ports:
      app: seekpath
      mappings:
      - http:80:80
      - https:443:80
    tags: my_dokku_apps

  - name: Create apps for dokku users
    include_tasks: user-single.yml
    vars:
      dokku_user: "{{ item }}"
    with_items: "{{ dokku_users }}"
    tags: my_dokku_users

  - name: Configure ACLs, set set dokku superuser
    become: true
    lineinfile:
      path: "~dokku/.dokkurc/acl"
      line: "{{ item }}"
      create: true
      owner: dokku
      mode: '0644'
    with_items:
    - export DOKKU_ACL_ALLOW_COMMAND_LINE=1
    # 'default' is the dokku user associated with logging in via SSH
    # You can pick any other dokku user configured
    # - export DOKKU_SUPER_USER=' default'
    # limit commands that non-superusers can run globally
    - export DOKKU_ACL_USER_COMMANDS="help version"
    - export DOKKU_ACL_PER_APP_COMMANDS="logs urls ps:rebuild ps:restart ps:stop ps:start git-upload-pack git-upload-archive git-receive-pack git-hook storage:list proxy:ports proxy:ports-set proxy:report enter config:bundle config:clear config:export config:get config:keys config:set config:unset"  # noqa 204
    tags: my_dokku_superuser
